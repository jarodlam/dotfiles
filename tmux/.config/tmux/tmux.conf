# Fix mac https://github.com/tmux-plugins/tpm/blob/master/docs/tpm_not_working.md
set-environment -g PATH "/opt/homebrew/bin:/bin:/usr/bin"

# Set prefix
set -g prefix C-a

# Bind <prefix>-r to reload config
unbind r
bind r source-file ~/.config/tmux/tmux.conf

# Support RGB colours
set -g default-terminal "xterm-256color"
set -ag terminal-overrides ",xterm-256color:Tc"

# Set new panes to open in current directory
bind c new-window -c '#{pane_current_path}'
bind '"' split-window -c '#{pane_current_path}'
bind % split-window -h -c '#{pane_current_path}'

# Instant esc key
set -s escape-time 0

# Enable mouse mode
set -g mouse on

# Act like vim
setw -g mode-keys vi
bind-key h select-pane -L
bind-key j select-pane -D
bind-key k select-pane -U
bind-key l select-pane -R

# Don't auto exit copy mode with mouse https://github.com/tmux/tmux/issues/140#issuecomment-443089576
unbind-key -T copy-mode-vi MouseDragEnd1Pane

# Scrollback size
set -g history-limit 999999999
# set -g history-limit 2000

# Fade inactive panes
set -g focus-events on
set -g window-active-style 'fg=#{@thm_fg},bg=default'
set -g window-style 'fg=#{@thm_surface_2},bg=default'

# Rename windows to current directory
set-option -g status-interval 1
set-option -g automatic-rename on
set-option -g automatic-rename-format '#{b:pane_current_path}'

# Force Nix to re-source https://github.com/NixOS/nix/issues/13255#issuecomment-3658512358
set-option -g default-command "env -u __ETC_PROFILE_NIX_SOURCED $SHELL"

# Catppuccin options
set -g @catppuccin_flavor 'mocha'
set -g @catppuccin_pane_border_style 'fg=#{@thm_surface_1},bg=#{@thm_bg}'
set -g @catppuccin_pane_active_border_style 'fg=#{@thm_surface_2},bg=#{@thm_bg}'
set -g @catppuccin_window_status_style 'rounded'
set -g @catppuccin_window_default_text ' #W '
set -g @catppuccin_window_number_position 'left'
set -g @catppuccin_window_text ' #W '
set -g @catppuccin_window_default_text ' #W '
set -g @catppuccin_window_current_text ' #W '
set -g @catppuccin_window_current_number_color '#{@thm_lavender}'
# set -g @catppuccin_status_background 'none' # this breaks the window icon colours
set -g @catppuccin_status_background '#{@thm_bg}'
set -g @catppuccin_status_connect_separator 'yes'
set -g @catppuccin_status_application_text_fg '#{@thm_crust}'
set -g @catppuccin_status_application_icon_fg '#{@thm_crust}'
set -g @catppuccin_status_application_text_bg '#{@thm_sapphire}'
set -g @catppuccin_status_application_icon_bg '#{@thm_sapphire}'
set -g @catppuccin_status_user_icon_fg '#{@thm_crust}'
set -g @catppuccin_status_user_text_fg '#{@thm_crust}'
set -g @catppuccin_status_user_icon_bg '#{@thm_green}'
set -g @catppuccin_status_user_text_bg '#{@thm_green}'
set -g @catppuccin_status_host_text_fg '#{@thm_fg}'
set -g @catppuccin_status_host_icon_fg '#{@thm_fg}'
set -g @catppuccin_status_host_text_bg '#{@thm_surface_1}'
set -g @catppuccin_status_host_icon_bg '#{@thm_surface_1}'
set -g @catppuccin_status_cpu_text_fg '#{@thm_crust}'
set -g @catppuccin_status_cpu_icon_fg '#{@thm_crust}'
set -g @catppuccin_status_cpu_text_bg '#{@thm_peach}'
set -g @catppuccin_status_cpu_icon_bg '#{@thm_peach}'
set -g @catppuccin_status_date_time_text_fg '#{@thm_crust}'
set -g @catppuccin_status_date_time_icon_fg '#{@thm_crust}'
set -g @catppuccin_status_date_time_text_bg '#{@thm_red}'
set -g @catppuccin_status_date_time_icon_bg '#{@thm_red}'

# Manually load Catppuccin now so that options are defined for status line below
run '#{TMUX_PLUGIN_MANAGER_PATH}/tmux/catppuccin.tmux'

# Catppuccin Mocha greyscale overrides
set -ogq @thm_bg "#262626"
set -ogq @thm_fg "#e1e1e1"
set -ogq @thm_subtext_1 "#cccccc"
set -ogq @thm_subtext_0 "#b7b7b7"
set -ogq @thm_overlay_2 "#a2a2a2"
set -ogq @thm_overlay_1 "#8e8e8e"
set -ogq @thm_overlay_0 "#797979"
set -ogq @thm_surface_2 "#646464"
set -ogq @thm_surface_1 "#505050"
set -ogq @thm_surface_0 "#3a3a3a"
set -ogq @thm_mantle "#1f1f1f"
set -ogq @thm_crust "#161616"

# List of plugins
set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'christoomey/vim-tmux-navigator'
set -g @plugin 'catppuccin/tmux#v2.1.3'
set -g @plugin 'tmux-plugins/tmux-battery'
set -g @plugin 'tmux-plugins/tmux-cpu'

# Install TPM if not found
setenv -g TMUX_PLUGIN_MANAGER_PATH "$HOME/.tmux/plugins/"
if 'test ! -d ~/.tmux/plugins/tpm' \
   'run "git clone https://github.com/tmux-plugins/tpm ~/.tmux/plugins/tpm && ~/.tmux/plugins/tpm/bin/install_plugins"'

# Init TPM to get access to CPU and battery plugins
run '~/.tmux/plugins/tpm/tpm'

# Session
set -g @session_color_normal '#{@thm_surface_2}'
set -g @session_color_prefix '#{@thm_red}'
set -g @session_color_copy '#{@thm_yellow}'
set -g @session_color_bg '#{?client_prefix,#{E:@session_color_prefix},#{?pane_in_mode,#{E:@session_color_copy},#{E:@session_color_normal}}}'
set -g @session_color_fg '#{?#{!=:#{E:@session_color_bg},#{E:@session_color_normal}},#{@thm_crust},#{@thm_fg}}'

# Status line
set -g status-position bottom
set -g status-right-length 100
set -g status-left-length 100
set -g status-left ''
set -agF status-left '#[fg=#{@session_color_bg},bg=default]'
set -ag status-left ''
set -agF status-left '#[fg=#{@session_color_fg},bg=#{@session_color_bg}]'
set -ag status-left '#S '
set -agF status-left '#[fg=#{@session_color_bg},bg=default]'
set -ag status-left '  '
set -g status-right ''
set -ag status-right '#{E:@catppuccin_status_host}'
set -ag status-right '#[fg=#{@thm_surface_1},bg=default]'
# set -ag status-right '#{E:@catppuccin_status_application}'
# set -ag status-right '#{E:@catppuccin_status_user}'
# set -ag status-right '#{E:@catppuccin_status_host}'
# set -agF status-right '#{E:@catppuccin_status_cpu}'
# set -ag status-right '#{E:@catppuccin_status_date_time}'
# set -ag status-right '#[fg=#{@thm_red},bg=default]'

# Initialize TMUX plugin manager (keep this line at the very bottom of tmux.conf)
run '~/.tmux/plugins/tpm/tpm'

# Blank line above status, must be below tpm https://github.com/catppuccin/tmux/issues/192
set -gu status-format  # reset to default value
set -gF status-format[1] '#{status-format[0]}'
set -g status-format[0] ''
set -g status 2
