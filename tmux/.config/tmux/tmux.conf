# Fix mac https://github.com/tmux-plugins/tpm/blob/master/docs/tpm_not_working.md
set-environment -g PATH "~/.nix-profile/bin:/opt/homebrew/bin:/bin:/usr/bin"

# Set prefix
set -g prefix C-a

# Bind <prefix>-r to reload config
unbind r
bind r source-file ~/.config/tmux/tmux.conf

# Support RGB colours
set -g default-terminal "tmux-256color"
set -ag terminal-overrides ",tmux-256color:Tc"

# Set new panes to open in current directory
bind c new-window -c '#{pane_current_path}'
bind '"' split-window -c '#{pane_current_path}'
bind % split-window -h -c '#{pane_current_path}'

# Instant esc key
set -s escape-time 0

# Enable mouse mode
set -g mouse on

# Act like vim
setw -g mode-keys vi
bind-key h select-pane -L
bind-key j select-pane -D
bind-key k select-pane -U
bind-key l select-pane -R

# Don't auto exit copy mode with mouse https://github.com/tmux/tmux/issues/140#issuecomment-443089576
unbind-key -T copy-mode-vi MouseDragEnd1Pane

# Scrollback size
# set -g history-limit 999999999
set -g history-limit 2000

# Fade inactive panes
set -g focus-events on
set -g window-active-style 'fg=#{@thm_fg},bg=default'
set -g window-style 'fg=#{@thm_surface_2},bg=default'

# Rename windows to current directory
set-option -g status-interval 1
set-option -g automatic-rename on
set-option -g automatic-rename-format '#{b:pane_current_path}'

# Force Nix to re-source https://github.com/NixOS/nix/issues/13255#issuecomment-3658512358
set-option -g default-command "env -u __ETC_PROFILE_NIX_SOURCED $SHELL"

# Catppuccin Mocha colours
# https://github.com/catppuccin/tmux/blob/main/themes/catppuccin_mocha_tmux.conf
# set -ogq @thm_bg "#1e1e2e"
# set -ogq @thm_fg "#cdd6f4"
set -ogq @thm_rosewater "#f5e0dc"
set -ogq @thm_flamingo "#f2cdcd"
set -ogq @thm_pink "#f5c2e7"
set -ogq @thm_mauve "#cba6f7"
set -ogq @thm_red "#f38ba8"
set -ogq @thm_maroon "#eba0ac"
set -ogq @thm_peach "#fab387"
set -ogq @thm_yellow "#f9e2af"
set -ogq @thm_green "#a6e3a1"
set -ogq @thm_teal "#94e2d5"
set -ogq @thm_sky "#89dceb"
set -ogq @thm_sapphire "#74c7ec"
set -ogq @thm_blue "#89b4fa"
set -ogq @thm_lavender "#b4befe"
# set -ogq @thm_subtext_1 "#a6adc8"
# set -ogq @thm_subtext_0 "#bac2de"
# set -ogq @thm_overlay_2 "#9399b2"
# set -ogq @thm_overlay_1 "#7f849c"
# set -ogq @thm_overlay_0 "#6c7086"
# set -ogq @thm_surface_2 "#585b70"
# set -ogq @thm_surface_1 "#45475a"
# set -ogq @thm_surface_0 "#313244"
# set -ogq @thm_mantle "#181825"
# set -ogq @thm_crust "#11111b"

# Catppuccin Mocha greyscale overrides
# set -ogq @thm_bg "#262626"
set -ogq @thm_bg "#000000"
set -ogq @thm_fg "#e1e1e1"
set -ogq @thm_subtext_1 "#cccccc"
set -ogq @thm_subtext_0 "#b7b7b7"
set -ogq @thm_overlay_2 "#a2a2a2"
set -ogq @thm_overlay_1 "#8e8e8e"
set -ogq @thm_overlay_0 "#797979"
set -ogq @thm_surface_2 "#646464"
set -ogq @thm_surface_1 "#505050"
set -ogq @thm_surface_0 "#3a3a3a"
set -ogq @thm_mantle "#1f1f1f"
set -ogq @thm_crust "#161616"

# Command prompt styling
set -g message-style 'fg=#{@thm_fg},bg=#{@thm_bg}'

# Session status indicator
# Color definitions for different modes
set -g @session_color_normal '#{@thm_surface_1}'
set -g @session_color_prefix '#{@thm_red}'
set -g @session_color_copy '#{@thm_yellow}'
# Dynamic background color based on mode (#{E:...} wrappers enable multi-level expansion)
set -g @session_color_bg '#{?client_prefix,#{E:@session_color_prefix},#{?pane_in_mode,#{E:@session_color_copy},#{E:@session_color_normal}}}'
# Dynamic foreground color (dark text when active, light text when normal)
set -g @session_color_fg '#{?#{!=:#{E:@session_color_bg},#{E:@session_color_normal}},#{@thm_crust},#{@thm_fg}}'
# Stage 1 (config load, -gF flag): Expands #{@session_color_*} to conditionals with #{E:...}
# Stage 2 (display time, #{E:...}): Evaluates conditionals and expands #{E:...} to actual colors
# set -gF @status_session '#[fg=#{@session_color_bg},bg=default]#[fg=#{@session_color_fg},bg=#{@session_color_bg}] #S#[fg=#{@session_color_bg},bg=default]  '
set -g @status_session '#[fg=#{E:@session_color_bg},bg=default]#[fg=#{E:@session_color_fg},bg=#{E:@session_color_bg}] #S#[fg=#{E:@session_color_bg},bg=default]  '

# Hostname status indicator
# Platform detection using run-shell (synchronous execution at config load)
# All detection uses uname -a output for consistency
# Mac: sapphire background with apple icon
# Ubuntu: peach background with ubuntu icon  
# Other Linux: peach background with linux icon
run-shell 'UNAME=$(uname -a); \
if echo "$UNAME" | grep -q Darwin; then \
    tmux set -g @hostname_bg_color "#{@thm_sapphire}" \; set -g @hostname_icon "󰀵"; \
elif echo "$UNAME" | grep -qi Ubuntu; then \
    tmux set -g @hostname_bg_color "#{@thm_peach}" \; set -g @hostname_icon ""; \
else \
    tmux set -g @hostname_bg_color "#{@thm_peach}" \; set -g @hostname_icon "󰌽"; \
fi'
set -g @hostname_color_fg '#{@thm_crust}'
# Uses two-stage expansion: -gF expands once at load, #{E:...} expands again at display
set -gF @status_hostname '#[fg=#{E:@hostname_bg_color},bg=default]#[fg=#{@hostname_color_fg},bg=#{E:@hostname_bg_color}] #H #{@hostname_icon}#[fg=#{E:@hostname_bg_color},bg=default]'

# Status line
set -g status-style '#{bg=default}'
set -g status-position bottom
set -g status-right-length 100
set -g status-left-length 100
# Use #{E:...} to trigger stage 2 expansion of @status_session at display time
set -g status-left '#{E:@status_session}'
set -g status-right '#{E:@status_hostname}'
set -g window-status-format ' #I:#W#{?window_flags,#{window_flags}, } '
set -g window-status-current-format '#[fg=#{@thm_subtext_1},bg=default]#[fg=#{@thm_crust},bg=#{@thm_subtext_1}]#I:#W#{?window_flags,#{window_flags}, }#[fg=#{@thm_subtext_1},bg=default]'

# Blank line above status
# If using TPM, these lines must be below TPM load https://github.com/catppuccin/tmux/issues/192
set -gu status-format  # reset to default value
set -gF status-format[1] '#{status-format[0]}'
set -g status-format[0] ''
set -g status 2

# Load other plugins
run '~/.config/tmux/plugins/vim-tmux-navigator/vim-tmux-navigator.tmux'
